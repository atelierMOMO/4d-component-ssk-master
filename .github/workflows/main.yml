name: ðŸŒ€Build Component

on:
  push:
    branches:
    - main
    paths:
      - 'DATA/*'   
  workflow_dispatch:
  workflow_call:
  
jobs:     

  get:
    permissions: write-all
    strategy:
      fail-fast: false
      matrix:
        TOOL4D_PLATFORM: ["macos-latest"]
        TOOL4D_BRANCH: [20.x]
        TOOL4D_VERSION: [20.2]
        TOOL4D_BUILD: [latest] 
        TOOL4D_STARTUP_METHOD: [regenerate] 
        TOOL4D_STARTUP_PROJECT_PATH: [./rezept/Project/rezept.4DProject] 
    runs-on: ${{ matrix.TOOL4D_PLATFORM }}
    steps:

      - name: checkout 
        uses: actions/checkout@v4
    
      - name: get tool4d
        id: get
        uses: miyako/4D/.github/actions/get-tool@v1
        with:
          platform: ${{ matrix.TOOL4D_PLATFORM }}
          branch: ${{ matrix.TOOL4D_BRANCH }}
          version: ${{ matrix.TOOL4D_VERSION }}
          build: ${{ matrix.TOOL4D_BUILD }}
          
      - name: build component
        uses: ./.github/actions/build-component
        with:
          tool4d_download_url: ${{ steps.get.outputs.tool4d_download_url }}
          tool4d_executable_path: ${{ steps.get.outputs.tool4d_executable_path }}
          startup_method: ${{ matrix.TOOL4D_STARTUP_METHOD }}
          project_path: ${{ matrix.TOOL4D_STARTUP_PROJECT_PATH }}  

      - name: bump
        id: bump
        uses: ./.github/actions/bump
        with:
          mode: patch

      - name: create release 
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        with:
          tag_name: ${{ steps.bump.outputs.version }}
          release_name: ${{ steps.bump.outputs.version }}
          draft: false
          prerelease: false  

      - name: ls
        run: |
          ls .
    
      - name: deploy                                        
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: steps.release.outputs.upload_url
          asset_path: /Users/runner/work/4d-component-ssk-master/4d-component-ssk-master/Components/rezept.4dbase/
          asset_name: rezept.4dbase
          asset_content_type: application/octet-stream
